{{- $dest := .Destination -}}
{{- $alt := .Text | plainify -}}
{{- $title := .Title -}}
{{- $isRemote := or (hasPrefix $dest "http://") (hasPrefix $dest "https://") -}}

{{- if $isRemote -}}
<img src="{{ $dest | safeURL }}" alt="{{ $alt }}" loading="lazy" decoding="async"{{ with $title }} title="{{ . }}"{{ end }}>
{{- else -}}
  {{- $res := .Page.Resources.GetMatch $dest -}}
  {{- if not $res -}}
    {{- $res = .Page.Resources.GetMatch (printf "**/%s" $dest) -}}
  {{- end -}}

  {{- if $res -}}
    {{- $widths := slice 480 768 1024 1280 1600 -}}
    {{- $srcset := slice -}}
    {{- $srcsetWebp := slice -}}
    {{- $srcsetAvif := slice -}}

    {{- range $widths -}}
      {{- if ge $res.Width . -}}
        {{- $r := $res.Resize (printf "%dx" .) -}}
        {{- $w := $res.Resize (printf "%dx webp q80" .) -}}
        {{- $a := $res.Resize (printf "%dx avif q50" .) -}}
        {{- $srcset = $srcset | append (printf "%s %dw" $r.RelPermalink .) -}}
        {{- $srcsetWebp = $srcsetWebp | append (printf "%s %dw" $w.RelPermalink .) -}}
        {{- $srcsetAvif = $srcsetAvif | append (printf "%s %dw" $a.RelPermalink .) -}}
      {{- end -}}
    {{- end -}}

    {{- if eq (len $srcset) 0 -}}
      {{- $srcset = slice (printf "%s %dw" $res.RelPermalink $res.Width) -}}
      {{- $srcsetWebp = slice (printf "%s %dw" ($res.Resize (printf "%dx webp q80" $res.Width)).RelPermalink $res.Width) -}}
      {{- $srcsetAvif = slice (printf "%s %dw" ($res.Resize (printf "%dx avif q50" $res.Width)).RelPermalink $res.Width) -}}
    {{- end -}}

    {{- $sizes := "(min-width: 1024px) 900px, 100vw" -}}
    <picture>
      <source type="image/avif" srcset="{{ delimit $srcsetAvif ", " }}" sizes="{{ $sizes }}">
      <source type="image/webp" srcset="{{ delimit $srcsetWebp ", " }}" sizes="{{ $sizes }}">
      <img
        src="{{ $res.RelPermalink }}"
        srcset="{{ delimit $srcset ", " }}"
        sizes="{{ $sizes }}"
        width="{{ $res.Width }}"
        height="{{ $res.Height }}"
        alt="{{ $alt }}"
        loading="lazy"
        decoding="async"{{ with $title }} title="{{ . }}"{{ end }}>
    </picture>
  {{- else -}}
    {{- $clean := strings.TrimPrefix "/" $dest -}}
    {{- $ext := path.Ext $clean -}}
    {{- $base := strings.TrimSuffix $ext $clean -}}
    {{- $webpExists := fileExists (printf "static/%s.webp" $base) -}}
    {{- $avifExists := fileExists (printf "static/%s.avif" $base) -}}

    {{- if or $webpExists $avifExists -}}
      <picture>
        {{- if $avifExists -}}
        <source type="image/avif" srcset="{{ printf "/%s.avif" $base }}">
        {{- end -}}
        {{- if $webpExists -}}
        <source type="image/webp" srcset="{{ printf "/%s.webp" $base }}">
        {{- end -}}
        <img src="{{ $dest | relURL }}" alt="{{ $alt }}" loading="lazy" decoding="async"{{ with $title }} title="{{ . }}"{{ end }}>
      </picture>
    {{- else -}}
      <img src="{{ $dest | relURL }}" alt="{{ $alt }}" loading="lazy" decoding="async"{{ with $title }} title="{{ . }}"{{ end }}>
    {{- end -}}
  {{- end -}}
{{- end -}}
